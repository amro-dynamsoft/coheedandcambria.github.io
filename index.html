<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dynamsoft MRZ Scanner - Workflow 1 Testing</title>
    <!-- Eruda: mobile dev-tools console (remove before shipping) -->
    <script src="//cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>
    <script src="../dist/mrz-scanner.bundle.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      h1 {
        font-size: 24px;
        margin-bottom: 10px;
      }

      .controls {
        background: #f5f5f5;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .control-group {
        margin-bottom: 15px;
      }

      .control-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .checkbox-group {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }

      .checkbox-group label {
        font-weight: normal;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
      }

      button:hover {
        background: #0056b3;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      #results {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        min-height: 200px;
      }

      .result-section {
        margin-bottom: 30px;
      }

      .result-section h2 {
        font-size: 18px;
        margin-bottom: 10px;
        color: #333;
      }

      .images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .image-container {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        background: #fafafa;
      }

      .image-container h3 {
        font-size: 14px;
        margin: 0 0 10px 0;
        color: #555;
      }

      .image-container canvas {
        max-width: 100%;
        height: auto;
        border: 1px solid #ccc;
      }

      .data-field {
        display: flex;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }

      .data-field:last-child {
        border-bottom: none;
      }

      .data-label {
        font-weight: bold;
        min-width: 200px;
        color: #555;
      }

      .data-value {
        color: #333;
        word-break: break-word;
      }

      .scenario-info {
        background: #e7f3ff;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        border-left: 4px solid #007bff;
      }

      .scenario-info strong {
        color: #0056b3;
      }

      .error-message {
        background: #ffe7e7;
        color: #c00;
        padding: 15px;
        border-radius: 4px;
        border-left: 4px solid #c00;
      }
    </style>
  </head>

  <body>
    <h1>MRZ Scanner - Workflow 1 Testing</h1>

    <div class="controls">
      <div class="control-group">
        <label>Select Configuration Parameters:</label>
        <div class="checkbox-group">
          <label>
            <input type="checkbox" id="returnOriginalImage" checked />
            returnOriginalImage
          </label>
          <label>
            <input type="checkbox" id="returnDocumentImage" checked />
            returnDocumentImage
          </label>
          <label>
            <input type="checkbox" id="returnPortraitImage" checked />
            returnPortraitImage
          </label>
        </div>
      </div>

      <div class="control-group">
        <label>Expected Document Type:</label>
        <div class="checkbox-group">
          <label>
            <input type="radio" name="docType" value="passport" checked />
            Passport (same-side scanning)
          </label>
          <label>
            <input type="radio" name="docType" value="id-card" />
            ID Card (different-side scanning)
          </label>
        </div>
      </div>

      <button id="startScan" onclick="startScanning()">Start Scanning</button>
    </div>

    <div id="results"></div>

    <script>
      let mrzscanner;

      // Initialize the scanner once
      (async () => {
        try {
          mrzscanner = new Dynamsoft.MRZScanner({
            license: "DLS2eyJoYW5kc2hha2VDb2RlIjoiMzE0NTQwLU16RTBOVFF3TFhkbFlpMVVjbWxoYkZCeWIybyIsIm1haW5TZXJ2ZXJVUkwiOiJodHRwczovL21kbHMuZHluYW1zb2Z0b25saW5lLmNvbS8iLCJvcmdhbml6YXRpb25JRCI6IjMxNDU0MCIsInN0YW5kYnlTZXJ2ZXJVUkwiOiJodHRwczovL3NkbHMuZHluYW1zb2Z0b25saW5lLmNvbS8iLCJjaGVja0NvZGUiOjEwOTA0MTkwMDB9",
          });
          console.log("MRZ Scanner initialized successfully");
        } catch (error) {
          console.error("Failed to initialize scanner:", error);
          document.getElementById("results").innerHTML =
            `<div class="error-message">Failed to initialize scanner: ${error.message}</div>`;
          document.getElementById("startScan").disabled = true;
        }
      })();

      function getScenarioNumber(returnOriginal, returnDoc, returnPortrait, docType) {
        // Determine scenario number based on Workflow 1 specification
        let scenarioBase;

        if (returnOriginal && returnDoc && returnPortrait) {
          scenarioBase = 1;
        } else if (returnOriginal && returnDoc && !returnPortrait) {
          scenarioBase = 2;
        } else if (returnOriginal && !returnDoc && returnPortrait) {
          scenarioBase = 3;
        } else if (!returnOriginal && returnDoc && returnPortrait) {
          scenarioBase = 4;
        } else if (returnOriginal && !returnDoc && !returnPortrait) {
          scenarioBase = 5;
        } else if (!returnOriginal && returnDoc && !returnPortrait) {
          scenarioBase = 6;
        } else if (!returnOriginal && !returnDoc && returnPortrait) {
          scenarioBase = 7;
        } else {
          scenarioBase = 8;
        }

        // Add offset for different-side scenarios
        return docType === 'id-card' ? scenarioBase + 8 : scenarioBase;
      }

      async function startScanning() {
        const resultContainer = document.getElementById("results");
        const startBtn = document.getElementById("startScan");

        // Get configuration
        const returnOriginalImage = document.getElementById("returnOriginalImage").checked;
        const returnDocumentImage = document.getElementById("returnDocumentImage").checked;
        const returnPortraitImage = document.getElementById("returnPortraitImage").checked;
        const docType = document.querySelector('input[name="docType"]:checked').value;

        // Calculate scenario number
        const scenarioNumber = getScenarioNumber(
          returnOriginalImage,
          returnDocumentImage,
          returnPortraitImage,
          docType
        );

        // Update UI
        resultContainer.innerHTML = `<div class="scenario-info">
          <strong>Testing Scenario ${scenarioNumber}</strong><br/>
          Configuration: returnOriginalImage=${returnOriginalImage},
          returnDocumentImage=${returnDocumentImage},
          returnPortraitImage=${returnPortraitImage}<br/>
          Expected: ${docType === 'passport' ? 'Same-side scanning (Passport)' : 'Different-side scanning (ID Card)'}
        </div>
        <p>Scanner launching... Please scan your document.</p>`;

        startBtn.disabled = true;

        try {
          // Dispose existing scanner and create new one with updated configuration
          if (mrzscanner) {
            mrzscanner.dispose();
          }

          mrzscanner = new Dynamsoft.MRZScanner({
            license: "DLS2eyJoYW5kc2hha2VDb2RlIjoiMzE0NTQwLU16RTBOVFF3TFhkbFlpMVVjbWxoYkZCeWIybyIsIm1haW5TZXJ2ZXJVUkwiOiJodHRwczovL21kbHMuZHluYW1zb2Z0b25saW5lLmNvbS8iLCJvcmdhbml6YXRpb25JRCI6IjMxNDU0MCIsInN0YW5kYnlTZXJ2ZXJVUkwiOiJodHRwczovL3NkbHMuZHluYW1zb2Z0b25saW5lLmNvbS8iLCJjaGVja0NvZGUiOjEwOTA0MTkwMDB9",
            returnOriginalImage,
            returnDocumentImage,
            returnPortraitImage,
          });

          const result = await mrzscanner.launch();
          console.log("Scan result:", result);

          // Display results
          displayResults(result, scenarioNumber, {
            returnOriginalImage,
            returnDocumentImage,
            returnPortraitImage,
            docType
          });

        } catch (error) {
          console.error("Scanning error:", error);
          resultContainer.innerHTML +=
            `<div class="error-message">Scanning error: ${error.message}</div>`;
        } finally {
          startBtn.disabled = false;
        }
      }

      function displayResults(result, scenarioNumber, config) {
        const resultContainer = document.getElementById("results");

        if (!result || !result.data) {
          resultContainer.innerHTML = `
            <div class="scenario-info">
              <strong>Scenario ${scenarioNumber} Result</strong>
            </div>
            <div class="error-message">No MRZ data detected. Please try again.</div>`;
          return;
        }

        let html = `
          <div class="scenario-info">
            <strong>Scenario ${scenarioNumber} - Scan Completed Successfully</strong><br/>
            Configuration: returnOriginalImage=${config.returnOriginalImage},
            returnDocumentImage=${config.returnDocumentImage},
            returnPortraitImage=${config.returnPortraitImage}
          </div>`;

        // Display Images
        html += '<div class="result-section"><h2>Captured Images</h2><div class="images-grid">';

        let imageCount = 0;

        // Original Images
        if (config.returnOriginalImage) {
          const primaryOriginal = result.getOriginalImage(Dynamsoft.EnumDocumentSide.MRZ);
          if (primaryOriginal && primaryOriginal.toCanvas) {
            html += createImageHTML("Original Image (MRZ Side)", primaryOriginal);
            imageCount++;
          }

          const secondaryOriginal = result.getOriginalImage(Dynamsoft.EnumDocumentSide.Opposite);
          if (secondaryOriginal && secondaryOriginal.toCanvas) {
            html += createImageHTML("Original Image (Portrait Side)", secondaryOriginal);
            imageCount++;
          }
        }

        // Document Images
        if (config.returnDocumentImage) {
          const primaryDoc = result.getDocumentImage(Dynamsoft.EnumDocumentSide.MRZ);
          if (primaryDoc && primaryDoc.toCanvas) {
            html += createImageHTML("Document Image (MRZ Side)", primaryDoc);
            imageCount++;
          }

          const secondaryDoc = result.getDocumentImage(Dynamsoft.EnumDocumentSide.Opposite);
          if (secondaryDoc && secondaryDoc.toCanvas) {
            html += createImageHTML("Document Image (Portrait Side)", secondaryDoc);
            imageCount++;
          }
        }

        // Portrait Image
        if (config.returnPortraitImage) {
          const portrait = result.getPortraitImage();
          if (portrait && portrait.toCanvas) {
            html += createImageHTML("Portrait Image", portrait);
            imageCount++;
          }
        }

        html += '</div>';
        html += `<p><strong>Total Images Captured: ${imageCount}</strong></p>`;
        html += '</div>';

        // Display MRZ Data
        html += '<div class="result-section"><h2>MRZ Data</h2>';

        Object.entries(result.data).forEach(([key, value]) => {
          // Skip invalidFields in display
          if (key === 'invalidFields') return;

          // Get human-readable label
          const enumKey = 'EnumMRZData';
          const labelKey = Dynamsoft[enumKey] ? Dynamsoft[enumKey][key.charAt(0).toUpperCase() + key.slice(1)] : key;
          const label = Dynamsoft.MRZDataLabel && labelKey ? Dynamsoft.MRZDataLabel[labelKey] : key;
          let displayValue = value;

          // Format dates using Dynamsoft utility if available
          if ((key === 'dateOfBirth' || key === 'dateOfExpiry') && value) {
            if (typeof Dynamsoft.displayMRZDate === 'function') {
              displayValue = Dynamsoft.displayMRZDate(value);
            } else if (value.year && value.month && value.day) {
              displayValue = `${value.year}-${String(value.month).padStart(2, '0')}-${String(value.day).padStart(2, '0')}`;
            }
          }

          html += `
            <div class="data-field">
              <div class="data-label">${label}:</div>
              <div class="data-value">${displayValue}</div>
            </div>`;
        });

        // Show invalid fields if any
        if (result.data.invalidFields && result.data.invalidFields.length > 0) {
          html += `
            <div class="data-field" style="background: #fff3cd; margin-top: 10px; padding: 10px;">
              <div class="data-label">Invalid Fields:</div>
              <div class="data-value">${result.data.invalidFields.join(', ')}</div>
            </div>`;
        }

        html += '</div>';

        resultContainer.innerHTML = html;

        // Actually render the canvases (must be done after HTML is in DOM)
        setTimeout(() => {
          renderCanvases(result, config);
        }, 0);
      }

      function createImageHTML(label, imageData) {
        return `
          <div class="image-container">
            <h3>${label}</h3>
            <div class="canvas-placeholder" data-label="${label}"></div>
          </div>`;
      }

      function renderCanvases(result, config) {
        // Original Images
        if (config.returnOriginalImage) {
          const primaryOriginal = result.getOriginalImage(Dynamsoft.EnumDocumentSide.MRZ);
          if (primaryOriginal && primaryOriginal.toCanvas) {
            insertCanvas("Original Image (MRZ Side)", primaryOriginal);
          }

          const secondaryOriginal = result.getOriginalImage(Dynamsoft.EnumDocumentSide.Opposite);
          if (secondaryOriginal && secondaryOriginal.toCanvas) {
            insertCanvas("Original Image (Portrait Side)", secondaryOriginal);
          }
        }

        // Document Images
        if (config.returnDocumentImage) {
          const primaryDoc = result.getDocumentImage(Dynamsoft.EnumDocumentSide.MRZ);
          if (primaryDoc && primaryDoc.toCanvas) {
            insertCanvas("Document Image (MRZ Side)", primaryDoc);
          }

          const secondaryDoc = result.getDocumentImage(Dynamsoft.EnumDocumentSide.Opposite);
          if (secondaryDoc && secondaryDoc.toCanvas) {
            insertCanvas("Document Image (Portrait Side)", secondaryDoc);
          }
        }

        // Portrait Image
        if (config.returnPortraitImage) {
          const portrait = result.getPortraitImage();
          if (portrait && portrait.toCanvas) {
            insertCanvas("Portrait Image", portrait);
          }
        }
      }

      function insertCanvas(label, imageData) {
        const placeholder = document.querySelector(`[data-label="${label}"]`);
        if (placeholder) {
          const canvas = imageData.toCanvas();
          canvas.style.maxWidth = "100%";
          canvas.style.height = "auto";
          placeholder.appendChild(canvas);
        }
      }
    </script>
  </body>
</html>
